<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>戸上アプリ Well-being</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* ブランドカラー定義 */
            --primary: #FF8C42;       /* Anzu Orange */
            --primary-light: #FFCC80;
            --primary-dark: #F57C00;
            --secondary: #4FC3F7;     /* Onsen Blue */
            --secondary-dark: #0288D1;
            --accent: #66BB6A;        /* Nature Green */
            --bg-body: #F5F7FA;
            --surface: #FFFFFF;
            --text-main: #263238;
            --text-sub: #78909C;
            --danger: #FF5252;
            --success: #4CAF50;
            --gold: #FFD700;
            /* UI変数 */
            --header-height: 60px;
            --nav-height: 85px;
            --radius-l: 24px;
            --radius-m: 16px;
            --radius-s: 8px;
            --shadow-card: 0 4px 20px rgba(0,0,0,0.05);
            --shadow-float: 0 8px 30px rgba(255, 140, 66, 0.3);
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            
            /* フォントサイズ変数（設定で変更可能） */
            --fs-base: 16px;
            --fs-h2: 1.5rem;
            --fs-card-title: 1.1rem;
        }
        /* --- 文字サイズ変更用クラス --- */
        body.text-large {
            --fs-base: 20px;
            --fs-h2: 1.8rem;
            --fs-card-title: 1.4rem;
        }
        /* --- 基本リセット --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0;
            padding-top: calc(var(--header-height) + var(--safe-top));
            padding-bottom: calc(var(--nav-height) + var(--safe-bottom));
            overflow-x: hidden;
            user-select: none;
            font-size: var(--fs-base); /* 変数化 */
            transition: font-size 0.3s;
        }
        /* --- ユーティリティ --- */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* --- ヘッダー --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%;
            height: calc(var(--header-height) + var(--safe-top));
            padding-top: var(--safe-top);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            display: flex; align-items: center; justify-content: space-between;
            padding-left: 20px; padding-right: 20px;
            z-index: 1000; box-shadow: 0 1px 10px rgba(0,0,0,0.05);
        }
        .app-logo { font-size: 1.3rem; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .app-logo span { color: var(--primary); }
        
        .header-actions { display: flex; gap: 12px; }
        .icon-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: #F1F3F4; color: var(--text-main);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; cursor: pointer; transition: 0.2s;
        }
        .icon-btn:active { transform: scale(0.92); background: var(--primary-light); }
        /* --- ナビゲーション --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--surface);
            height: calc(var(--nav-height) + var(--safe-bottom));
            padding-bottom: var(--safe-bottom);
            display: flex; justify-content: space-around; align-items: center;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.05);
            z-index: 1000;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #B0BEC5; font-size: 0.7rem; gap: 4px; height: 100%;
            transition: 0.3s;
        }
        .nav-item i { font-size: 1.5rem; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-4px); }
        /* --- 共通コンポーネント --- */
        .page { display: none; padding: 20px; min-height: 80vh; padding-bottom: 40px; }
        .page.active { display: block; animation: fadeIn 0.4s ease; }
        .card {
            background: var(--surface); border-radius: var(--radius-l);
            padding: 24px; margin-bottom: 20px;
            box-shadow: var(--shadow-card); position: relative; overflow: hidden;
        }
        h2 { font-size: var(--fs-h2); margin: 0 0 16px; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        h2::before { content:''; width:6px; height:24px; background:var(--primary); border-radius:3px; }
        h3 { font-size: var(--fs-card-title); margin-bottom: 10px; }
        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 50px;
            font-size: 1rem; font-weight: bold; color: white;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            box-shadow: 0 8px 16px rgba(255, 140, 66, 0.3);
            cursor: pointer; transition: transform 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn:active { transform: scale(0.96); }
        .btn.secondary { background: linear-gradient(135deg, var(--secondary), var(--secondary-dark)); box-shadow: 0 8px 16px rgba(79, 195, 247, 0.3); }
        .btn.outline { background: transparent; border: 2px solid #ddd; color: var(--text-sub); box-shadow: none; }
        .btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; filter: grayscale(1); }
        /* --- トースト通知 & モーダル --- */
        .toast-container {
            position: fixed; bottom: calc(var(--nav-height) + var(--safe-bottom) + 20px); left: 0; right: 0;
            display: flex; flex-direction: column; align-items: center; pointer-events: none; z-index: 2000;
        }
        .toast {
            background: rgba(38, 50, 56, 0.9); color: white; padding: 12px 24px;
            border-radius: 30px; margin-top: 10px; font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: toastUp 0.3s ease, toastFade 3s forwards;
        }
        @keyframes toastUp { from { transform: translateY(20px); opacity:0; } to { transform: translateY(0); opacity:1; } }
        @keyframes toastFade { 0%, 80% { opacity:1; } 100% { opacity:0; visibility:hidden; } }
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000;
            display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; width: 85%; max-width: 320px; border-radius: var(--radius-l); padding: 30px 20px;
            text-align: center; transform: scale(0.9); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-icon { font-size: 3rem; margin-bottom: 15px; color: var(--primary); }
        
        /* --- 1. ホーム画面 --- */
        .hero-section {
            background: linear-gradient(120deg, var(--primary), #FFB74D);
            border-radius: var(--radius-l); padding: 30px; color: white;
            margin-bottom: 24px; position: relative; box-shadow: var(--shadow-float);
        }
        .weather-widget { position: absolute; top: 20px; right: 20px; text-align: right; }
        .points-display { margin-top:20px; font-weight:bold; font-size:2rem; cursor: pointer; display: inline-block; transition: 0.2s; }
        .points-display:active { transform: scale(0.95); opacity: 0.8; }
        
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .menu-card {
            background: var(--surface); border-radius: var(--radius-m); padding: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 140px; text-align: center; box-shadow: var(--shadow-card);
            transition: transform 0.1s; position: relative;
        }
        .menu-card:active { transform: scale(0.95); }
        .menu-icon { font-size: 2.5rem; margin-bottom: 12px; }
        .menu-label { font-weight: bold; font-size: 0.95rem; color: var(--text-main); }
        .menu-sub { font-size: 0.7rem; color: var(--text-sub); margin-top: 4px; }
        .badge-update {
            position: absolute; top: 10px; right: 10px; width: 10px; height: 10px;
            background: var(--danger); border-radius: 50%; border: 2px solid white;
        }
        /* --- ポイント・ガチャ画面 --- */
        .tab-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border-radius: 20px; border: none; font-weight: bold; color: var(--text-sub); background: #eee; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(255, 140, 66, 0.3); }
        .gacha-stage {
            height: 250px; position: relative; display: flex; align-items: center; justify-content: center;
            background: #FFF3E0; border-radius: var(--radius-l); overflow: hidden; margin-bottom: 20px;
            border: 4px solid var(--primary);
            transition: transform 0.1s;
        }
        .gacha-stage.shake-machine { animation: machineShake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        @keyframes machineShake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }
        .gacha-machine-img { font-size: 8rem; color: var(--primary); z-index: 1; transition: 0.2s; }
        .capsule {
            position: absolute; font-size: 5rem; color: var(--secondary); opacity: 0;
            top: 20%; z-index: 10;
        }
        .capsule.animate { animation: capsuleFall 1.0s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        @keyframes capsuleFall {
            0% { top: -20%; opacity: 1; transform: rotate(0deg); }
            60% { top: 60%; transform: rotate(720deg); }
            80% { top: 50%; transform: rotate(700deg); }
            100% { top: 55%; opacity: 1; transform: rotate(720deg) scale(1.5); }
        }
        
        .gacha-result-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 4000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.5s;
        }
        .gacha-result-overlay.active { opacity: 1; pointer-events: auto; }
        
        .gacha-shine {
            position: absolute; width: 100%; height: 100%;
            background: repeating-conic-gradient(from 0deg, rgba(255,255,255,0.1) 0deg 10deg, transparent 10deg 20deg);
            animation: spin 8s linear infinite; pointer-events: none;
        }
        .flash-overlay {
            position: fixed; inset: 0; background: white; z-index: 3999;
            opacity: 0; pointer-events: none;
        }
        .flash-overlay.flash { animation: flashAnim 0.5s ease-out; }
        @keyframes flashAnim { 0% { opacity: 1; } 100% { opacity: 0; } }
        .gacha-card {
            background: white; width: 80%; padding: 30px; border-radius: 20px; text-align: center;
            transform: scale(0.5); opacity: 0; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; z-index: 4001;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
        }
        .gacha-result-overlay.active .gacha-card { transform: scale(1); opacity: 1; transition-delay: 0.2s; }
        
        .confetti {
            position: absolute; width: 10px; height: 10px; background: #f00;
            animation: confettiFall 3s linear forwards; z-index: 4002;
        }
        @keyframes confettiFall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .coupon-ticket {
            background: #fff; border: 2px dashed var(--primary);
            padding: 15px; margin: 10px 0; border-radius: 12px;
            display: flex; align-items: center; gap: 15px; text-align: left;
        }
        .coupon-icon { font-size: 2rem; color: var(--secondary); width: 50px; text-align: center; }
        .coupon-content h4 { margin: 0; color: var(--text-main); }
        .coupon-content p { margin: 5px 0 0; font-size: 0.8rem; color: var(--text-sub); }
        .exchange-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border-bottom: 1px solid #eee;
        }
        .exchange-btn { padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; background: var(--accent); color: white; border: none; cursor: pointer; }
        /* --- アミューズメント --- */
        .amusement-hero {
            border-radius: var(--radius-l); margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            padding: 24px; color: white;
            box-shadow: var(--shadow-card);
        }
        .game-select-card { display: flex; align-items: center; gap: 20px; padding: 20px; cursor: pointer; }
        .game-thumb { width: 80px; height: 80px; border-radius: 16px; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 2rem; }
        
        .quiz-container { text-align: center; padding-top: 20px; }
        .quiz-progress { height: 8px; background: #eee; border-radius: 4px; margin-bottom: 30px; overflow: hidden; }
        .quiz-bar { height: 100%; background: var(--secondary); width: 0%; transition: width 0.3s; }
        .quiz-question { font-size: 1.3rem; font-weight: bold; margin-bottom: 30px; line-height: 1.6; text-align: left; }
        .quiz-options { display: grid; gap: 12px; }
        .quiz-btn { padding: 18px; border: 2px solid #E0E0E0; border-radius: 12px; background: white; font-size: 1rem; font-weight: bold; transition: 0.2s; }
        .quiz-btn:active { background: #f5f5f5; border-color: var(--secondary); transform: scale(0.98); }
        .stamp-card-view {
            background: #FFFBE6; border: 4px double #D4AF37; border-radius: 10px;
            padding: 20px; margin-bottom: 20px; position: relative;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.05);
        }
        .stamp-card-title {
            text-align: center; font-family: serif; color: #5D4037;
            border-bottom: 1px solid #D4AF37; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold;
        }
        .stamp-grid { display: flex; justify-content: space-around; gap: 10px; }
        .stamp-slot {
            width: 80px; height: 80px; border: 2px dashed #BCAAA4; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; position: relative;
            background: rgba(255,255,255,0.5);
        }
        .stamp-mark {
            width: 70px; height: 70px; border: 3px solid #D32F2F; border-radius: 50%;
            color: #D32F2F; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-family: serif; transform: rotate(-15deg);
            font-size: 1.2rem; background: rgba(211, 47, 47, 0.1);
            position: absolute; opacity: 0; transform: scale(2) rotate(-15deg); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .stamp-mark.visible { opacity: 1; transform: scale(1) rotate(-15deg); }
        .map-view {
            background: #E8F5E9; height: 300px; border-radius: var(--radius-l);
            position: relative; overflow: hidden; margin-bottom: 20px; border: 4px solid white; box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        .map-spot {
            position: absolute; width: 44px; height: 44px; background: white;
            border-radius: 50%; border: 3px solid var(--text-sub);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; color: var(--text-sub); cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.3s; z-index: 5;
        }
        .map-spot.active { border-color: var(--primary); color: var(--primary); transform: scale(1.1); z-index: 10; animation: bounce 2s infinite; }
        .map-spot.stamped { background: var(--primary); color: white; border-color: white; transform: scale(1); animation: none; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
        .chat-ui { display: flex; flex-direction: column; gap: 15px; margin-bottom: 80px; }
        .chat-msg { 
            background: white; padding: 15px; border-radius: 0 16px 16px 16px;
            align-self: flex-start; max-width: 90%; box-shadow: var(--shadow-card); line-height: 1.6;
        }
        .chat-msg.user { background: var(--secondary-dark); color: white; border-radius: 16px 0 16px 16px; align-self: flex-end; }
        .chat-options { display: grid; gap: 10px; position: fixed; bottom: 80px; left: 20px; right: 20px; z-index: 100; }
        .omikuji-stage { 
            height: 400px; display: flex; align-items: center; justify-content: center; 
            perspective: 1000px; position: relative; overflow: hidden;
            background: radial-gradient(circle, #FFF 0%, #FFF3E0 100%);
            border-radius: var(--radius-l);
        }
        .omikuji-box-img { 
            font-size: 8rem; color: var(--primary); cursor: pointer; 
            text-shadow: 0 5px 15px rgba(255, 140, 66, 0.4); 
            z-index: 10; transition: transform 0.1s;
        }
        .omikuji-stick {
            position: absolute; width: 20px; height: 120px; background: #FFD700;
            top: 50%; left: 50%; margin-left: -10px; margin-top: -60px;
            z-index: 5; transform: translateY(100px); opacity: 0;
        }
        
        .shaking { animation: violentShake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        @keyframes violentShake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        .stick-appear { animation: stickOut 1s forwards; }
        @keyframes stickOut { 0% { transform: translateY(50px); opacity:1; } 100% { transform: translateY(-150px); opacity:1; } }
        .sakura {
            position: absolute; background-color: #ffc0cb; border-radius: 100% 0 100% 0; opacity: 0;
            width: 10px; height: 10px; animation: fall-sakura 4s linear infinite; z-index: 20;
        }
        @keyframes fall-sakura {
            0% { top: -10%; transform: rotate(0deg); opacity: 1; }
            100% { top: 110%; transform: rotate(360deg); opacity: 0; }
        }
        .omikuji-result-card { 
            background: white; padding: 40px 20px; border-radius: var(--radius-l); text-align: center; 
            border: 4px solid var(--primary); 
            animation: expand 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; z-index: 30;
        }
        @keyframes expand { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .point-circle {
            width: 140px; height: 140px; border-radius: 50%;
            background: conic-gradient(var(--primary) 0%, #eee 0);
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 20px; position: relative;
        }
        .point-inner { width: 120px; height: 120px; background: white; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .user-name-container {
            display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px;
        }
        .name-display { font-size: 1.5rem; font-weight: bold; }
        .edit-icon { color: var(--text-sub); cursor: pointer; font-size: 1rem; }
        .name-edit-box { display: none; gap: 5px; }
        .name-edit-box.active { display: flex; }
        .name-input { padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 1rem; width: 180px; }
        .setting-group {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px solid #eee;
        }
        .setting-label { font-size: 1rem; font-weight: bold; }
        .toggle-switch {
            position: relative; display: inline-block; width: 50px; height: 26px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px;
            left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }
        .setting-select {
            padding: 8px; border-radius: 8px; border: 1px solid #ddd; background: #fff; font-size: 0.9rem;
        }
        .feedback-overlay {
            position: fixed; inset: 0; z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.9); pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        .feedback-icon { font-size: 8rem; transform: scale(0.5); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .correct { color: var(--success); }
        .incorrect { color: var(--danger); }
        .feedback-active { opacity: 1; }
        .feedback-active .feedback-icon { transform: scale(1); }
    </style>
</head>
<body>
    <header>
        <div class="app-logo"><i class="fa-solid fa-leaf"></i> <span>戸上</span>アプリ</div>
        <div class="header-actions">
            <div class="icon-btn" onclick="openPage('page-info')"><i class="fa-solid fa-circle-info"></i></div>
            <div class="icon-btn" onclick="openPage('page-settings')"><i class="fa-solid fa-gear"></i></div>
        </div>
    </header>
    <main>
        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-content">
                <div id="modal-icon" class="modal-icon"></div>
                <h3 id="modal-title" style="margin:0 0 10px;">Title</h3>
                <p id="modal-msg" style="color:#666; margin:0 0 20px;">Message</p>
                <button class="btn" onclick="closeModal()">OK</button>
            </div>
        </div>
        
        <div id="flash-overlay" class="flash-overlay"></div>
        <div id="toast-container" class="toast-container"></div>
        <div id="page-home" class="page active">
            <div class="hero-section">
                <div class="weather-widget">
                    <i class="fa-solid fa-sun"></i> 15°C<br>千曲市
                </div>
                <h1 style="margin:0; font-size:1.4rem;" data-lang-ja="こんにちは" data-lang-en="Hello">こんにちは</h1>
                <p style="margin:5px 0 0; opacity:0.9;" data-lang-ja="今日の気分はいかがですか？" data-lang-en="How are you feeling today?">今日の気分はいかがですか？</p>
                <div class="points-display" onclick="openPage('page-point-hub')">
                    <i class="fa-solid fa-coins"></i> <span id="home-points">--</span> <span style="font-size:1rem;">pt</span>
                    <div style="font-size:0.7rem; opacity:0.8; font-weight:normal;">タップして使う・貯める</div>
                </div>
            </div>
            <h2 data-lang-ja="メニュー" data-lang-en="Menu">メニュー</h2>
            <div class="menu-grid">
                <div class="menu-card" onclick="openPage('page-amusement-menu')">
                    <div class="badge-update"></div>
                    <i class="fa-solid fa-gamepad menu-icon" style="color: #FF6B6B;"></i>
                    <div class="menu-label" data-lang-ja="アミューズメント" data-lang-en="Amusement">アミューズメント</div>
                    <div class="menu-sub">クイズ・スタンプラリー</div>
                </div>
                <div class="menu-card" onclick="startOnsenDiagnosis()">
                    <i class="fa-solid fa-hot-tub-person menu-icon" style="color: var(--secondary);"></i>
                    <div class="menu-label" data-lang-ja="温泉診断" data-lang-en="Onsen Diagnosis">温泉診断</div>
                    <div class="menu-sub">あなたに合う湯</div>
                </div>
                <div class="menu-card" onclick="openPage('page-kairan')">
                    <i class="fa-solid fa-clipboard-list menu-icon" style="color: var(--accent);"></i>
                    <div class="menu-label" data-lang-ja="回覧板" data-lang-en="Circular">回覧板</div>
                    <div class="menu-sub">デジタル回覧板</div>
                </div>
                <div class="menu-card" onclick="openPage('page-random')">
                    <i class="fa-solid fa-store menu-icon" style="color: #AB47BC;"></i>
                    <div class="menu-label" data-lang-ja="ランダムお店" data-lang-en="Random Shop">ランダムお店</div>
                    <div class="menu-sub">今日のおみくじ</div>
                </div>
            </div>
        </div>
        <div id="page-point-hub" class="page">
            <button class="btn outline" onclick="openPage('page-home')" style="margin-bottom:15px; width:auto;"><i class="fa-solid fa-arrow-left"></i> ホームへ</button>
            <div style="text-align:center; margin-bottom:20px;">
                <div style="font-size:0.9rem; color:var(--text-sub);">現在の保有ポイント</div>
                <div style="font-size:2.5rem; font-weight:bold; color:var(--primary);"><i class="fa-solid fa-coins"></i> <span id="hub-points">--</span></div>
            </div>
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchPointTab('gacha')" id="tab-gacha">クーポンガチャ</button>
                <button class="tab-btn" onclick="switchPointTab('exchange')" id="tab-exchange">ポイント交換</button>
            </div>
            <div id="content-gacha">
                <div class="card gacha-stage" id="gacha-machine">
                    <i class="fa-solid fa-box gacha-machine-img" id="machine-icon"></i>
                    <i class="fa-solid fa-capsule capsule" id="gacha-capsule"></i>
                </div>
                <div style="text-align:center; margin-bottom:20px; font-size:0.9rem; color:#666;">
                    1回 100pt でお得なクーポンが当たる！
                </div>
                <button class="btn" onclick="playGacha()" id="btn-draw-gacha">
                    100ptで回す
                </button>
            </div>
            <div id="gacha-result-overlay" class="gacha-result-overlay">
                <div class="gacha-shine"></div>
                <div id="confetti-container"></div>
                <div class="gacha-card">
                    <h2 style="color:var(--primary); justify-content:center; font-size:2rem;">GET!</h2>
                    <div id="new-coupon-display"></div>
                    <button class="btn" onclick="closeGachaResult()">受け取る</button>
                </div>
            </div>
            <div id="content-exchange" class="hidden">
                <div class="card">
                    <h3><i class="fa-solid fa-gift"></i> ポイント交換</h3>
                    <p style="font-size:0.8rem; margin-bottom:15px;">貯まったポイントを景品と交換できます。</p>
                    
                    <div class="exchange-item">
                        <div>
                            <div style="font-weight:bold;">戸上アプリ特製ステッカー</div>
                            <div style="font-size:0.8rem; color:#888;">300 pt</div>
                        </div>
                        <button class="exchange-btn" onclick="exchangeItem('ステッカー', 300)">交換</button>
                    </div>
                    <div class="exchange-item">
                        <div>
                            <div style="font-weight:bold;">千曲市オリジナルエコバッグ</div>
                            <div style="font-size:0.8rem; color:#888;">800 pt</div>
                        </div>
                        <button class="exchange-btn" onclick="exchangeItem('エコバッグ', 800)">交換</button>
                    </div>
                    <div class="exchange-item">
                        <div>
                            <div style="font-weight:bold;">戸倉上山田温泉 入浴剤セット</div>
                            <div style="font-size:0.8rem; color:#888;">1,200 pt</div>
                        </div>
                        <button class="exchange-btn" onclick="exchangeItem('入浴剤セット', 1200)">交換</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="page-my-coupons" class="page">
             <button class="btn outline" onclick="openPage('page-account')" style="margin-bottom:15px; width:auto;"><i class="fa-solid fa-arrow-left"></i> 戻る</button>
             <h2>所持クーポン</h2>
             <div id="coupon-list-container" style="padding-bottom:20px;"></div>
        </div>
        <div id="page-amusement-menu" class="page">
            <button class="btn outline" onclick="openPage('page-home')" style="margin-bottom:20px; width:auto; display:inline-flex;">
                <i class="fa-solid fa-arrow-left"></i> 戻る
            </button>
            <h2>アミューズメント</h2>
            <div class="amusement-hero">
                <div>
                    <h3 style="margin:0;">千曲を楽しむ</h3>
                    <p style="margin: 5px 0 0;">遊びながらポイントを貯めよう！</p>
                </div>
            </div>
            <div class="card game-select-card" onclick="initQuiz()">
                <div class="game-thumb" style="background:#FFF3E0; color:var(--primary);"><i class="fa-solid fa-graduation-cap"></i></div>
                <div class="game-info">
                    <h3>戸上クイズ</h3>
                    <p>千曲市の知識を試そう！全3問。</p>
                </div>
            </div>
            <div class="card game-select-card" onclick="initStampRally()">
                <div class="game-thumb" style="background:#E1F5FE; color:var(--secondary);"><i class="fa-solid fa-map-location-dot"></i></div>
                <div class="game-info">
                    <h3>戸上スタンプラリー</h3>
                    <p>街を歩いてスタンプを集めよう。</p>
                </div>
            </div>
        </div>
        <div id="page-quiz-game" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button class="btn outline" onclick="openPage('page-amusement-menu')" style="width:auto; padding:8px 16px; font-size:0.8rem;">中断</button>
                <div style="font-weight:bold;">Q. <span id="quiz-num">1</span>/3</div>
            </div>
            <div class="quiz-container">
                <div class="quiz-progress"><div id="quiz-bar-fill" class="quiz-bar"></div></div>
                <div id="quiz-content">
                    <div class="quiz-question" id="question-text">ここに問題が表示されます</div>
                    <div class="quiz-options" id="answer-buttons"></div>
                </div>
                <div id="quiz-result-view" class="hidden">
                    <i class="fa-solid fa-trophy" style="font-size:4rem; color:#FFD700; margin-bottom:20px;"></i>
                    <h3>クイズ終了！</h3>
                    <p>あなたの正解数は...</p>
                    <div style="font-size:3rem; font-weight:bold; color:var(--primary); margin:10px 0;"><span id="quiz-score">0</span> / 3</div>
                    <p>獲得ポイント: <span id="quiz-points">0</span> pt</p>
                    <button class="btn" onclick="openPage('page-amusement-menu')">メニューへ戻る</button>
                </div>
            </div>
        </div>
        <div id="page-stamp-rally" class="page">
            <button class="btn outline" onclick="openPage('page-amusement-menu')" style="margin-bottom:15px; width:auto;"><i class="fa-solid fa-arrow-left"></i> 戻る</button>
            <h2>スタンプラリー</h2>
            <div class="stamp-card-view">
                <div class="stamp-card-title">戸上スタンプラリー</div>
                <div class="stamp-grid">
                    <div class="stamp-slot" id="slot-s1"><div class="stamp-mark" id="mark-s1">戸上<br>神社</div></div>
                    <div class="stamp-slot" id="slot-s2"><div class="stamp-mark" id="mark-s2">千曲<br>駅</div></div>
                    <div class="stamp-slot" id="slot-s3"><div class="stamp-mark" id="mark-s3">万葉<br>公園</div></div>
                </div>
            </div>
            <div class="map-view" id="stamp-map"></div>
            <div class="card">
                <h3 id="spot-name">スポットを選択してください</h3>
                <p id="spot-desc" style="color:#666;">地図上のピンをタップして詳細を確認しましょう。</p>
                <button class="btn secondary" id="stamp-btn" disabled>
                    <i class="fa-solid fa-location-dot"></i> QRコードを読み込む
                </button>
            </div>
        </div>
        <div id="page-onsen" class="page">
            <button class="btn outline" onclick="openPage('page-home')" style="margin-bottom:15px; width:auto;">中断</button>
            <h2>温泉診断</h2>
            <div id="onsen-chat-area" class="chat-ui"></div>
            <div id="onsen-options" class="chat-options"></div>
        </div>
        <div id="page-kairan" class="page">
            <button class="btn outline" onclick="openPage('page-home')" style="margin-bottom:15px; width:auto;">戻る</button>
            <h2>デジタル回覧板</h2>
            <div class="kairan-list" id="kairan-list-view">
                <div class="kairan-item urgent" style="background:white; padding:15px; border-radius:12px; margin-bottom:10px; border-left:4px solid var(--danger);" onclick="showModal('重要', '2/1よりゴミ収集日が変更になります。詳細は市ホームページをご確認ください。', 'fa-triangle-exclamation')">
                    <div><div style="font-size:0.8rem;">2026.02.01</div><div style="font-weight:bold;">【重要】ゴミ収集日変更</div></div>
                </div>
                <div class="kairan-item" style="background:white; padding:15px; border-radius:12px; border-left:4px solid var(--secondary);" onclick="showModal('公民館だより', '2月のイベントスケジュールが公開されました。', 'fa-newspaper')">
                    <div><div style="font-size:0.8rem;">2026.01.20</div><div style="font-weight:bold;">公民館だより 2月号</div></div>
                </div>
            </div>
        </div>
        <div id="page-random" class="page">
            <button class="btn outline" onclick="openPage('page-home')" style="margin-bottom:15px; width:auto;">戻る</button>
            <h2>今日のおみくじ＆お店</h2>
            <div id="omikuji-stage" class="omikuji-stage">
                <div id="sakura-container"></div>
                <i class="fa-solid fa-box-open omikuji-box-img" id="omikuji-box" onclick="playOmikuji()"></i>
                <div class="omikuji-stick" id="omikuji-stick"></div>
            </div>
            <p style="text-align:center; color:var(--text-sub);" id="omikuji-hint">箱をタップして運勢を占おう！</p>
            <div id="omikuji-result" class="omikuji-result-card hidden">
                <div style="font-size:0.9rem; color:#888;">今日の運勢</div>
                <div style="font-size:4rem; font-weight:bold; color:var(--danger); margin:10px 0; font-family: serif;" id="fortune-text">大吉</div>
                <div style="background:#F5F5F5; border-radius:12px; padding:15px; margin-top:20px; text-align:left;">
                    <span style="background:var(--secondary); color:white; font-size:0.7rem; padding:3px 8px; border-radius:4px;">おすすめスポット</span>
                    <h3 style="margin:10px 0;" id="shop-name">手打ちそば くるみ亭</h3>
                    <p style="font-size:0.9rem; color:#555;" id="shop-desc">千曲川のせせらぎを聞きながら、名物のくるみ蕎麦を堪能できます。</p>
                </div>
                <button class="btn" style="margin-top:20px;" onclick="showToast('マップを起動しました')">マップを開く</button>
            </div>
        </div>
        <div id="page-account" class="page">
            <h2 data-lang-ja="マイページ" data-lang-en="My Page">マイページ</h2>
            <div class="card" style="text-align:center;">
                <div class="point-circle">
                    <div class="point-inner">
                        <span style="font-size:0.8rem; color:#888;">現在のP</span>
                        <strong style="font-size:1.8rem; color:var(--primary);" id="account-points">--</strong>
                    </div>
                </div>
                <div class="user-name-container">
                    <div id="display-name-area" style="display:flex; align-items:center; gap:10px;">
                        <span class="name-display" id="user-name-text">千曲 太郎</span>
                        <i class="fa-solid fa-pen edit-icon" onclick="startEditName()"></i>
                    </div>
                    <div id="edit-name-area" class="name-edit-box">
                        <input type="text" id="user-name-input" class="name-input" maxlength="10">
                        <button class="btn" style="width:auto; padding:8px 15px;" onclick="saveName()">保存</button>
                    </div>
                </div>
                <button class="btn secondary" onclick="openPage('page-my-coupons')"><i class="fa-solid fa-ticket"></i> 所持クーポンを見る</button>
            </div>
            <h3 style="font-size:1.1rem; margin-top:30px;">設定</h3>
            <div class="card">
                 <div style="padding:15px 0; border-bottom:1px solid #eee; cursor:pointer;" onclick="openPage('page-settings')">アプリ設定</div>
                 <div style="padding:15px 0; border-bottom:1px solid #eee; color:var(--danger); cursor:pointer;" onclick="resetData()">データのリセット</div>
            </div>
        </div>
        
        <div id="page-info" class="page">
            <button class="btn outline" onclick="openPage('page-home')" style="margin-bottom:15px; width:auto;"><i class="fa-solid fa-arrow-left"></i> 閉じる</button>
            <h2>アプリについて</h2>
            <div class="card">
                <h3><i class="fa-solid fa-bullseye" style="color:var(--primary);"></i> アプリの目的</h3>
                <p style="font-size: 0.9rem; line-height: 1.6;">
                    千曲市の魅力を再発見し、地域とのつながりを深めながら、皆さまの日々の生活をより豊かにすることを目的としています。
                </p>
            </div>
        </div>
        
        <div id="page-settings" class="page">
             <button class="btn outline" onclick="openPage('page-home')" style="margin-bottom:15px; width:auto;">閉じる</button>
             <h2 data-lang-ja="設定" data-lang-en="Settings">設定</h2>
             <div class="card">
                 <div class="setting-group">
                     <span class="setting-label">文字サイズ</span>
                     <select id="setting-font" class="setting-select" onchange="changeFontSize(this.value)">
                         <option value="normal">標準</option>
                         <option value="large">大</option>
                     </select>
                 </div>
                 <div class="setting-group">
                     <span class="setting-label">言語 (Language)</span>
                     <select id="setting-lang" class="setting-select" onchange="changeLanguage(this.value)">
                         <option value="ja">日本語</option>
                         <option value="en">English</option>
                     </select>
                 </div>
                 <div class="setting-group">
                     <span class="setting-label">プッシュ通知</span>
                     <label class="toggle-switch">
                         <input type="checkbox" id="setting-notif" onchange="changeNotification(this.checked)">
                         <span class="slider"></span>
                     </label>
                 </div>
             </div>
        </div>
    </main>
    <div id="feedback" class="feedback-overlay">
        <i id="feedback-icon" class="fa-solid fa-circle-check feedback-icon correct"></i>
    </div>
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="openPage('page-home')" id="nav-home">
            <i class="fa-solid fa-house"></i><span data-lang-ja="ホーム" data-lang-en="Home">ホーム</span>
        </div>
        <div class="nav-item" onclick="openPage('page-account')" id="nav-account">
            <i class="fa-solid fa-user"></i><span data-lang-ja="アカウント" data-lang-en="Account">アカウント</span>
        </div>
    </nav>
    <script>
        // --- UIヘルパー ---
        function showModal(title, msg, iconClass = 'fa-circle-info') {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            document.getElementById('modal-icon').innerHTML = `<i class="fa-solid ${iconClass}"></i>`;
            document.getElementById('modal-overlay').classList.add('show');
        }
        function closeModal() { document.getElementById('modal-overlay').classList.remove('show'); }
        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            el.innerText = msg;
            container.appendChild(el);
            setTimeout(() => { el.remove(); }, 3500);
        }
        
        // --- データ管理 ---
        const APP_DATA_KEY = 'chikuma_app_v4_data';
        let appData = {
            points: 1250, coupons: [], stamps: [], userName: "千曲 太郎",
            settings: { fontSize: "normal", language: "ja", notifications: true }
        };
        function loadData() {
            const stored = localStorage.getItem(APP_DATA_KEY);
            if(stored) {
                const parsed = JSON.parse(stored);
                appData = { ...appData, ...parsed, settings: { ...appData.settings, ...parsed.settings } };
            }
            updatePointsUI();
            applySettingsUI();
            document.getElementById('user-name-text').innerText = appData.userName;
        }
        function saveData() {
            localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData));
            updatePointsUI();
        }
        function resetData() {
            if(confirm('本当にデータを初期化しますか？')) {
                localStorage.removeItem(APP_DATA_KEY);
                location.reload();
            }
        }
        function updatePointsUI() {
            const p = appData.points.toLocaleString();
            document.getElementById('home-points').innerText = p;
            document.getElementById('hub-points').innerText = p;
            document.getElementById('account-points').innerText = p;
            const container = document.getElementById('coupon-list-container');
            container.innerHTML = '';
            if(appData.coupons.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">クーポンを持っていません。</div>';
            } else {
                appData.coupons.forEach(c => { container.innerHTML += createCouponHTML(c); });
            }
        }
        function addPoints(amount) {
            appData.points += amount;
            saveData();
            showToast(`${amount}pt 獲得しました！`);
        }
        function usePoints(amount) {
            if(appData.points >= amount) {
                appData.points -= amount;
                saveData();
                return true;
            }
            showModal('ポイント不足', `この操作には ${amount}pt 必要です。`, 'fa-coins');
            return false;
        }
        
        // --- 設定 ---
        function applySettingsUI() {
            document.getElementById('setting-font').value = appData.settings.fontSize;
            if(appData.settings.fontSize === 'large') document.body.classList.add('text-large');
            else document.body.classList.remove('text-large');
            document.getElementById('setting-lang').value = appData.settings.language;
            updateLanguageUI(appData.settings.language);
            document.getElementById('setting-notif').checked = appData.settings.notifications;
        }
        function changeFontSize(val) {
            appData.settings.fontSize = val;
            saveData();
            if(val === 'large') document.body.classList.add('text-large');
            else document.body.classList.remove('text-large');
        }
        function changeLanguage(val) {
            appData.settings.language = val;
            saveData();
            updateLanguageUI(val);
        }
        function updateLanguageUI(lang) {
            const elements = document.querySelectorAll(`[data-lang-${lang}]`);
            elements.forEach(el => { el.innerText = el.getAttribute(`data-lang-${lang}`); });
        }
        function changeNotification(checked) {
            appData.settings.notifications = checked;
            saveData();
        }
        
        // --- 名前変更 ---
        function startEditName() {
            document.getElementById('display-name-area').style.display = 'none';
            document.getElementById('edit-name-area').classList.add('active');
            document.getElementById('user-name-input').value = appData.userName;
        }
        function saveName() {
            const newName = document.getElementById('user-name-input').value;
            if(newName.trim() === "") return;
            appData.userName = newName;
            saveData();
            document.getElementById('user-name-text').innerText = newName;
            document.getElementById('edit-name-area').classList.remove('active');
            document.getElementById('display-name-area').style.display = 'flex';
        }
        
        // --- ページ遷移 ---
        function openPage(pageId) {
            window.scrollTo(0,0);
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(pageId === 'page-home') document.getElementById('nav-home').classList.add('active');
            if(pageId === 'page-account') document.getElementById('nav-account').classList.add('active');
            if(pageId === 'page-point-hub') switchPointTab('gacha'); 
        }
        
        // --- ガチャ ---
        function switchPointTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById('content-gacha').classList.add('hidden');
            document.getElementById('content-exchange').classList.add('hidden');
            document.getElementById('content-' + tab).classList.remove('hidden');
        }
        const couponPool = [
            { id: 1, name: "杏ソフト 50円引", desc: "観光会館等で使用可能", icon: "fa-ice-cream" },
            { id: 2, name: "日帰り温泉 100円引", desc: "温泉施設で使用可能", icon: "fa-hot-tub-person" },
            { id: 3, name: "お土産 5%OFF", desc: "道の駅等で使用可能", icon: "fa-gift" },
            { id: 4, name: "【大当たり】入浴無料券", desc: "1回入浴無料！", icon: "fa-star" }
        ];
        function playGacha() {
            if(!usePoints(100)) return;
            const btn = document.getElementById('btn-draw-gacha');
            const machine = document.getElementById('gacha-machine');
            const capsule = document.getElementById('gacha-capsule');
            btn.disabled = true;
            machine.classList.add('shake-machine');
            setTimeout(() => {
                machine.classList.remove('shake-machine');
                capsule.classList.add('animate');
            }, 800);
            setTimeout(() => {
                const rand = Math.random();
                let result = rand < 0.05 ? couponPool[3] : rand < 0.35 ? couponPool[1] : rand < 0.65 ? couponPool[0] : couponPool[2];
                appData.coupons.unshift(result);
                saveData();
                document.getElementById('flash-overlay').classList.add('flash');
                setTimeout(() => document.getElementById('flash-overlay').classList.remove('flash'), 500);
                document.getElementById('new-coupon-display').innerHTML = `<div style="font-size:4rem; color:var(--secondary); margin:10px;"><i class="fa-solid ${result.icon}"></i></div><h3 style="margin:5px 0;">${result.name}</h3><p style="color:#666;">${result.desc}</p>`;
                document.getElementById('gacha-result-overlay').classList.add('active');
                capsule.classList.remove('animate');
                btn.disabled = false;
            }, 1800);
        }
        function closeGachaResult() { document.getElementById('gacha-result-overlay').classList.remove('active'); }
        function createCouponHTML(coupon) {
            return `<div class="coupon-ticket"><div class="coupon-icon"><i class="fa-solid ${coupon.icon}"></i></div><div class="coupon-content"><h4>${coupon.name}</h4><p>${coupon.desc}</p></div></div>`;
        }
        function exchangeItem(itemName, cost) {
            if(confirm(`${itemName}を ${cost}pt で交換しますか？`)) {
                if(usePoints(cost)) showModal('交換完了', `${itemName}の交換完了。`, 'fa-check');
            }
        }
        
        // --- スタンプラリー ---
        const stampSpots = [
            { id: 's1', name: '戸上神社', desc: '歴史ある神社。', top: '20%', left: '30%', icon: 'fa-torii-gate' },
            { id: 's2', name: '千曲駅', desc: '旅の玄関口。', top: '50%', left: '60%', icon: 'fa-train' },
            { id: 's3', name: '万葉公園', desc: '歌碑がある公園。', top: '70%', left: '20%', icon: 'fa-tree' }
        ];
        function initStampRally() { openPage('page-stamp-rally'); renderStampCard(); renderMap(); }
        function renderStampCard() {
            stampSpots.forEach(spot => {
                const mark = document.getElementById(`mark-${spot.id}`);
                if(appData.stamps.includes(spot.id)) mark.classList.add('visible');
                else mark.classList.remove('visible');
            });
        }
        function renderMap() {
            const mapEl = document.getElementById('stamp-map');
            mapEl.innerHTML = ''; 
            stampSpots.forEach(spot => {
                const isStamped = appData.stamps.includes(spot.id);
                const el = document.createElement('div');
                el.className = `map-spot ${isStamped ? 'stamped' : 'active'}`;
                el.style.top = spot.top; el.style.left = spot.left;
                el.innerHTML = `<i class="fa-solid ${isStamped ? 'fa-check' : spot.icon}"></i>`;
                el.onclick = () => selectSpot(spot, isStamped);
                mapEl.appendChild(el);
            });
        }
        function selectSpot(spot, isStamped) {
            document.getElementById('spot-name').innerText = spot.name;
            document.getElementById('spot-desc').innerText = isStamped ? "取得済みです。" : spot.desc;
            const btn = document.getElementById('stamp-btn');
            btn.disabled = isStamped;
            btn.innerHTML = isStamped ? '<i class="fa-solid fa-check"></i> 取得済み' : '<i class="fa-solid fa-location-dot"></i> チェックイン';
            btn.onclick = () => getStamp(spot.id);
        }
        function getStamp(id) {
            const btn = document.getElementById('stamp-btn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>...';
            setTimeout(() => {
                if(!appData.stamps.includes(id)) { appData.stamps.push(id); addPoints(50); }
                renderStampCard(); renderMap();
                selectSpot(stampSpots.find(s => s.id === id), true);
            }, 1000);
        }
        
        // --- 温泉診断 (3問に増量) ---
        const onsenScenario = [
            { q: "1. 今の気分は？", options: [
                { txt: "癒やされたい", next: 1 },
                { txt: "リフレッシュしたい", next: 1 }
            ]},
            { q: "2. お湯の好みは？", options: [
                { txt: "硫黄の香り(本格派)", next: 2 },
                { txt: "肌に優しい単純泉", next: 2 }
            ]},
            { q: "3. 重視したいのは？", options: [
                { txt: "歴史を感じる風情", result: "A" },
                { txt: "設備の充実・新しさ", result: "B" }
            ]}
        ];
        const onsenResults = {
            "A": { name: "万葉超音波温泉", desc: "レトロな雰囲気と独特の硫黄泉が魅力。" },
            "B": { name: "湯の華銭湯 瑞祥", desc: "広々とした露天風呂とサウナが完備。" }
        };
        function startOnsenDiagnosis() {
            openPage('page-onsen');
            document.getElementById('onsen-chat-area').innerHTML = '';
            addBotMsg("あなたにぴったりの温泉を探します(全3問)");
            setTimeout(() => showOnsenQuestion(0), 600);
        }
        function addBotMsg(text) {
            const d = document.createElement('div'); d.className = 'chat-msg fade-in'; d.innerText = text;
            document.getElementById('onsen-chat-area').appendChild(d);
            window.scrollTo(0, document.body.scrollHeight);
        }
        function addUserMsg(text) {
            const d = document.createElement('div'); d.className = 'chat-msg user fade-in'; d.innerText = text;
            document.getElementById('onsen-chat-area').appendChild(d);
        }
        function showOnsenQuestion(idx) {
            const qData = onsenScenario[idx];
            addBotMsg(qData.q);
            const optArea = document.getElementById('onsen-options');
            optArea.innerHTML = '';
            qData.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'btn outline'; btn.style.background = 'white'; btn.innerText = opt.txt;
                btn.onclick = () => {
                    addUserMsg(opt.txt); optArea.innerHTML = '';
                    setTimeout(() => { if(opt.result) showOnsenFinalResult(opt.result); else showOnsenQuestion(opt.next); }, 600);
                };
                optArea.appendChild(btn);
            });
        }
        function showOnsenFinalResult(type) {
            const res = onsenResults[type] || onsenResults["A"];
            addBotMsg("診断結果が出ました！");
            setTimeout(() => {
                document.getElementById('onsen-chat-area').insertAdjacentHTML('beforeend', `<div class="card fade-in"><h3>${res.name}</h3><p>${res.desc}</p><button class="btn" onclick="openPage('page-home')">戻る</button></div>`);
                window.scrollTo(0, document.body.scrollHeight);
            }, 800);
        }
        
        // --- クイズ (連打防止修正済み) ---
        const quizData = [
            { q: "千曲市の名産品として有名な果物は？", a: ["あんず", "りんご", "ぶどう", "もも"], correct: 0 },
            { q: "「姨捨の棚田」は何に選定されている？", a: ["重要文化的景観", "世界遺産", "天然記念物", "国宝"], correct: 0 },
            { q: "戸倉上山田温泉の泉質の特徴は？", a: ["美肌の湯", "強酸性", "炭酸泉", "泥湯"], correct: 0 }
        ];
        let currentQuizIndex = 0, quizScore = 0;
        function initQuiz() {
            openPage('page-quiz-game');
            currentQuizIndex = 0; quizScore = 0;
            document.getElementById('quiz-result-view').classList.add('hidden');
            document.getElementById('quiz-content').classList.remove('hidden');
            showQuestion();
        }
        function showQuestion() {
            const data = quizData[currentQuizIndex];
            document.getElementById('quiz-num').innerText = currentQuizIndex + 1;
            document.getElementById('question-text').innerText = data.q;
            document.getElementById('quiz-bar-fill').style.width = ((currentQuizIndex) / quizData.length) * 100 + '%';
            const btnContainer = document.getElementById('answer-buttons');
            btnContainer.innerHTML = '';
            btnContainer.style.pointerEvents = 'auto'; // 回答許可
            data.a.forEach((ans, index) => {
                const btn = document.createElement('button');
                btn.className = 'quiz-btn'; btn.innerText = ans;
                btn.onclick = () => checkAnswer(index);
                btnContainer.appendChild(btn);
            });
        }
        function checkAnswer(selectedIndex) {
            // 連打防止: 選択肢エリアのクリックを無効化
            document.getElementById('answer-buttons').style.pointerEvents = 'none';
            const isCorrect = selectedIndex === quizData[currentQuizIndex].correct;
            const overlay = document.getElementById('feedback');
            const icon = document.getElementById('feedback-icon');
            icon.className = isCorrect ? 'fa-solid fa-circle-check feedback-icon correct' : 'fa-solid fa-circle-xmark feedback-icon incorrect';
            overlay.classList.add('feedback-active');
            if(isCorrect) quizScore++;
            setTimeout(() => {
                overlay.classList.remove('feedback-active');
                currentQuizIndex++;
                if (currentQuizIndex < quizData.length) showQuestion();
                else showQuizResult();
            }, 800);
        }
        function showQuizResult() {
            document.getElementById('quiz-content').classList.add('hidden');
            document.getElementById('quiz-result-view').classList.remove('hidden');
            document.getElementById('quiz-score').innerText = quizScore;
            const earned = quizScore * 10;
            document.getElementById('quiz-points').innerText = earned;
            document.getElementById('quiz-bar-fill').style.width = '100%';
            addPoints(earned);
        }
        
        // --- おみくじ ---
        function playOmikuji() {
            const box = document.getElementById('omikuji-box');
            const stick = document.getElementById('omikuji-stick');
            box.classList.add('shaking');
            setTimeout(() => {
                box.classList.remove('shaking');
                stick.classList.add('stick-appear');
                createSakura();
                setTimeout(() => {
                    document.getElementById('omikuji-stage').style.display = 'none';
                    document.getElementById('omikuji-result').classList.remove('hidden');
                    addPoints(10);
                }, 1200);
            }, 1500);
        }
        function createSakura() {
            const container = document.getElementById('sakura-container');
            for(let i=0; i<20; i++) {
                const el = document.createElement('div'); el.className = 'sakura';
                el.style.left = Math.random() * 100 + '%'; el.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(el);
            }
        }
        window.onload = loadData;
    </script>
</body>
</html>

